"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const jsdom_1 = require("jsdom");
exports.toughCookie = jsdom_1.toughCookie;
const deepmerge = require("deepmerge-plus");
const pack_1 = require("./pack");
exports.URL = pack_1.URL;
exports.URLImpl = pack_1.URLImpl;
const index_1 = require("./index");
const parseContentType = require("content-type-parser");
exports.parseContentType = parseContentType;
const isPlainObject = require("is-plain-object");
const cookies_1 = require("./cookies");
exports.LazyCookieJar = cookies_1.LazyCookieJar;
exports.LazyCookie = cookies_1.LazyCookie;
const cookies_2 = require("./cookies");
exports.CookieJar = cookies_2.CookieJar;
exports.RequestJar = cookies_2.RequestJar;
exports.wrapCookieJarForRequest = cookies_2.wrapCookieJarForRequest;
var const_1 = require("./const");
exports.DEFAULT_USER_AGENT = const_1.DEFAULT_USER_AGENT;
const const_2 = require("./const");
const html_1 = require("./html");
function fromURL(url, options) {
    return index_1.Promise.resolve().then(function () {
        const parsedURL = new pack_1.URL(url);
        url = parsedURL.href;
        let opts = {};
        options = pack_1.packOptions(options, function (options) {
            opts = options;
        });
        options = normalizeFromURLOptions(options);
        let requestOptions = normalizeRequestOptions(options);
        let _request = options.libRequestPromise || index_1.request;
        return _request(url, requestOptions)
            .then((res) => {
            return requestToJSDOM(res, parsedURL, options, requestOptions);
        })
            .then(function (jsdom) {
            if (!pack_1.isPackedJSDOM(jsdom)) {
                pack_1.packJSDOM(jsdom);
            }
            jsdom._options.ConstructorOptions = opts;
            jsdom._options.options = options;
            jsdom._options.requestOptions = requestOptions;
            return jsdom;
        });
    });
}
exports.fromURL = fromURL;
function requestToJSDOM(res, parsedURL, options, requestOptions) {
    if (typeof parsedURL == 'string') {
        parsedURL = new pack_1.URL(parsedURL);
    }
    let opts = {};
    options = pack_1.packOptions(options, function (options) {
        opts = options;
    });
    options = normalizeFromURLOptions(options);
    const parsedContentType = parseContentType(res.headers["content-type"]);
    const transportLayerEncodingLabel = parsedContentType && parsedContentType.get("charset");
    options = Object.assign(options, {
        url: res.request.href + parsedURL.hash,
        contentType: res.headers["content-type"],
        referrer: res.request.getHeader("referer"),
    });
    let body = html_1.normalizeHTML(res.body, transportLayerEncodingLabel).html;
    if (options.minifyHTML) {
        body = html_1.minifyHTML(body);
    }
    let jsdom = new jsdom_1.JSDOM(body, options);
    jsdom[const_2.SYMBOL_RAW] = jsdom[const_2.SYMBOL_RAW] || {};
    jsdom[const_2.SYMBOL_RAW].options = jsdom[const_2.SYMBOL_RAW].options || {};
    jsdom[const_2.SYMBOL_RAW].options.options = jsdom[const_2.SYMBOL_RAW].options.options || options;
    jsdom[const_2.SYMBOL_RAW].options.ConstructorOptions = jsdom[const_2.SYMBOL_RAW].options.ConstructorOptions || opts;
    jsdom[const_2.SYMBOL_RAW].options.Response = res;
    jsdom[const_2.SYMBOL_RAW].options.body = body;
    if (requestOptions) {
        jsdom[const_2.SYMBOL_RAW].options.requestOptions = jsdom[const_2.SYMBOL_RAW].options.requestOptions || requestOptions;
    }
    return jsdom;
}
exports.requestToJSDOM = requestToJSDOM;
function normalizeRequestOptions(options, _requestOptions) {
    let requestOptions = {
        resolveWithFullResponse: true,
        encoding: null,
        gzip: true,
        headers: {
            "User-Agent": options.userAgent || const_2.DEFAULT_USER_AGENT,
            Referer: options.referrer,
            Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Language": "en"
        },
        jar: cookies_2.wrapCookieJarForRequest(options.cookieJar)
    };
    if (options.requestOptions || _requestOptions) {
        requestOptions = deepmerge.all([
            requestOptions,
            options.requestOptions || {},
            _requestOptions || {},
            {
                encoding: null,
            },
        ], {
            isMergeableObject(value, isMergeable) {
                let bool = isMergeable(value);
                if (bool && typeof value == 'object' && !Array.isArray(value)) {
                    bool = isPlainObject(value);
                }
                return bool;
            },
        });
    }
    return requestOptions;
}
exports.normalizeRequestOptions = normalizeRequestOptions;
function normalizeFromURLOptions(options) {
    const normalized = Object.assign({}, options);
    if (options.userAgent === undefined) {
        normalized.userAgent = const_2.DEFAULT_USER_AGENT;
    }
    if (options.referrer !== undefined) {
        normalized.referrer = (new pack_1.URL(options.referrer)).href;
    }
    if (options.cookieJar === undefined) {
        normalized.cookieJar = new cookies_1.LazyCookieJar();
    }
    delete normalized.url;
    delete normalized.contentType;
    return normalized;
}
exports.normalizeFromURLOptions = normalizeFromURLOptions;
const self = require("./from-url");
exports.default = self;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJvbS11cmwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmcm9tLXVybC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLGlDQUEyRDtBQXVCbEQsc0JBdkJ1QixtQkFBVyxDQXVCdkI7QUF0QnBCLDRDQUE0QztBQUU1QyxpQ0FBbUk7QUFhMUgsY0FiNkYsVUFBRyxDQWE3RjtBQUFFLGtCQWI2RixjQUFPLENBYTdGO0FBWnJCLG1DQUE0RDtBQUM1RCx3REFBd0Q7QUFVL0MsNENBQWdCO0FBVHpCLGlEQUFpRDtBQUdqRCx1Q0FBd0U7QUFDL0Qsd0JBREEsdUJBQWEsQ0FDQTtBQUFFLHFCQURBLG9CQUFVLENBQ0E7QUFFbEMsdUNBQThGO0FBQ3JGLG9CQURBLG1CQUFTLENBQ0E7QUFBRSxxQkFEQSxvQkFBVSxDQUNBO0FBQUUsa0NBREEsaUNBQXVCLENBQ0E7QUFLdkQsaUNBQTZDO0FBQXBDLHFDQUFBLGtCQUFrQixDQUFBO0FBQzNCLG1DQUF5RDtBQUV6RCxpQ0FBbUQ7QUF1Q25ELFNBQWdCLE9BQU8sQ0FBQyxHQUFpQixFQUFFLE9BQXlCO0lBRW5FLE9BQU8sZUFBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQztRQUU3QixNQUFNLFNBQVMsR0FBRyxJQUFJLFVBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixHQUFHLEdBQUcsU0FBUyxDQUFDLElBQWMsQ0FBQztRQUUvQixJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFFZCxPQUFPLEdBQUcsa0JBQVcsQ0FBQyxPQUFPLEVBQUUsVUFBVSxPQUFPO1lBRS9DLElBQUksR0FBRyxPQUFPLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0MsSUFBSSxjQUFjLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdEQsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixJQUFJLGVBQU8sQ0FBQztRQUVwRCxPQUFPLFFBQVEsQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDO2FBQ2xDLElBQUksQ0FBQyxDQUFDLEdBQWMsRUFBRSxFQUFFO1lBRXhCLE9BQU8sY0FBYyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ2hFLENBQUMsQ0FBQzthQUVELElBQUksQ0FBQyxVQUFVLEtBQWE7WUFFNUIsSUFBSSxDQUFDLG9CQUFhLENBQUMsS0FBSyxDQUFDLEVBQ3pCO2dCQUNDLGdCQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDakI7WUFFRCxLQUFLLENBQUMsUUFBUSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztZQUN6QyxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7WUFDakMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1lBRS9DLE9BQU8sS0FBZSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUNEO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBeENELDBCQXdDQztBQWNELFNBQWdCLGNBQWMsQ0FBWSxHQUFjLEVBQUUsU0FBdUIsRUFBRSxPQUFpQyxFQUFFLGNBQWdDO0lBRXJKLElBQUksT0FBTyxTQUFTLElBQUksUUFBUSxFQUNoQztRQUNDLFNBQVMsR0FBRyxJQUFJLFVBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUMvQjtJQUVELElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUVkLE9BQU8sR0FBRyxrQkFBVyxDQUFDLE9BQU8sRUFBRSxVQUFVLE9BQU87UUFFL0MsSUFBSSxHQUFHLE9BQU8sQ0FBQztJQUNoQixDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sR0FBRyx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUUzQyxNQUFNLGlCQUFpQixHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUN4RSxNQUFNLDJCQUEyQixHQUFHLGlCQUFpQixJQUFJLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUUxRixPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7UUFDaEMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJO1FBQ3RDLFdBQVcsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQztRQUN4QyxRQUFRLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDO0tBRTFDLENBQUMsQ0FBQztJQUVILElBQUksSUFBSSxHQUFHLG9CQUFhLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSwyQkFBMkIsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUVyRSxJQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQ3RCO1FBQ0MsSUFBSSxHQUFHLGlCQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDeEI7SUFFRCxJQUFJLEtBQUssR0FBRyxJQUFJLGFBQUssQ0FBQyxJQUFJLEVBQUUsT0FBOEIsQ0FBQyxDQUFDO0lBRTVELEtBQUssQ0FBQyxrQkFBVSxDQUFDLEdBQUcsS0FBSyxDQUFDLGtCQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDNUMsS0FBSyxDQUFDLGtCQUFVLENBQUMsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLGtCQUFVLENBQUMsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO0lBQzVELEtBQUssQ0FBQyxrQkFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsa0JBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDO0lBQ2pGLEtBQUssQ0FBQyxrQkFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxrQkFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQztJQUVwRyxLQUFLLENBQUMsa0JBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDO0lBQ3pDLEtBQUssQ0FBQyxrQkFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFFdEMsSUFBSSxjQUFjLEVBQ2xCO1FBQ0MsS0FBSyxDQUFDLGtCQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxrQkFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLGNBQWMsSUFBSSxjQUFjLENBQUM7S0FDdEc7SUFHRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUM7QUFqREQsd0NBaURDO0FBRUQsU0FBZ0IsdUJBQXVCLENBQUMsT0FBd0IsRUFBRSxlQUFpQztJQUdsRyxJQUFJLGNBQWMsR0FBNkI7UUFDOUMsdUJBQXVCLEVBQUUsSUFBSTtRQUM3QixRQUFRLEVBQUUsSUFBSTtRQUNkLElBQUksRUFBRSxJQUFJO1FBQ1YsT0FBTyxFQUFFO1lBQ1IsWUFBWSxFQUFFLE9BQU8sQ0FBQyxTQUFTLElBQUksMEJBQWtCO1lBQ3JELE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUTtZQUN6QixNQUFNLEVBQUUsaUVBQWlFO1lBQ3pFLGlCQUFpQixFQUFFLElBQUk7U0FDdkI7UUFFRCxHQUFHLEVBQUUsaUNBQXVCLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztLQUMvQyxDQUFDO0lBRUYsSUFBSSxPQUFPLENBQUMsY0FBYyxJQUFJLGVBQWUsRUFDN0M7UUFDQyxjQUFjLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQztZQUM5QixjQUFjO1lBQ2QsT0FBTyxDQUFDLGNBQWMsSUFBSSxFQUFFO1lBQzVCLGVBQWUsSUFBSSxFQUFFO1lBQ3JCO2dCQUNDLFFBQVEsRUFBRSxJQUFJO2FBQ2Q7U0FDRCxFQUFFO1lBRUYsaUJBQWlCLENBQUMsS0FBSyxFQUFFLFdBQVc7Z0JBRW5DLElBQUksSUFBSSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFFOUIsSUFBSSxJQUFJLElBQUksT0FBTyxLQUFLLElBQUksUUFBUSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFDN0Q7b0JBQ0MsSUFBSSxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDNUI7Z0JBRUQsT0FBTyxJQUFJLENBQUM7WUFDYixDQUFDO1NBQ0QsQ0FBQyxDQUFDO0tBQ0g7SUFFRCxPQUFPLGNBQWMsQ0FBQztBQUN2QixDQUFDO0FBM0NELDBEQTJDQztBQUVELFNBQWdCLHVCQUF1QixDQUFJLE9BQXFDO0lBSS9FLE1BQU0sVUFBVSxHQUFpQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1RSxJQUFJLE9BQU8sQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUNuQztRQUVDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsMEJBQWtCLENBQUM7S0FDMUM7SUFFRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUNsQztRQUNDLFVBQVUsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLFVBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7S0FDdkQ7SUFFRCxJQUFJLE9BQU8sQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUNuQztRQUVDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsSUFBSSx1QkFBYSxFQUFFLENBQUM7S0FDM0M7SUFHRCxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUM7SUFFdEIsT0FBTyxVQUFVLENBQUMsV0FBVyxDQUFDO0lBRTlCLE9BQU8sVUFBVSxDQUFDO0FBSW5CLENBQUM7QUEvQkQsMERBK0JDO0FBSUQsbUNBQWtDO0FBRWxDLGtCQUFlLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvMi82LzAwNi5cbiAqL1xuXG5pbXBvcnQgKiBhcyBDb3JlUmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcbmltcG9ydCB7IEpTRE9NLCBGcm9tVXJsT3B0aW9ucywgdG91Z2hDb29raWUgfSBmcm9tICdqc2RvbSc7XG5pbXBvcnQgKiBhcyBkZWVwbWVyZ2UgZnJvbSAnZGVlcG1lcmdlLXBsdXMnO1xuXG5pbXBvcnQgeyBJQ29uc3RydWN0b3JPcHRpb25zLCBJSlNET00sIElPcHRpb25zLCBJT3B0aW9uc0pTRE9NLCBpc1BhY2tlZEpTRE9NLCBwYWNrSlNET00sIHBhY2tPcHRpb25zLCBVUkwsIFVSTEltcGwgfSBmcm9tICcuL3BhY2snO1xuaW1wb3J0IHsgUHJvbWlzZSwgcmVxdWVzdCwgUmVzcG9uc2VSZXF1ZXN0IH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgKiBhcyBwYXJzZUNvbnRlbnRUeXBlIGZyb20gJ2NvbnRlbnQtdHlwZS1wYXJzZXInO1xuaW1wb3J0ICogYXMgaXNQbGFpbk9iamVjdCBmcm9tICdpcy1wbGFpbi1vYmplY3QnO1xuaW1wb3J0IHsgSU9wdGlvbnNXaXRoV2luZG93T3B0aW9uc1dpdGhSZXNvdXJjZUxvYWRlciB9IGZyb20gJy4vYnJvd3Nlci9yZXNvdXJjZS1sb2FkZXInO1xuXG5pbXBvcnQgeyBMYXp5Q29va2llSmFyLCBMYXp5Q29va2llLCBSZXF1ZXN0Q29va2llSmFyIH0gZnJvbSAnLi9jb29raWVzJztcbmV4cG9ydCB7IExhenlDb29raWVKYXIsIExhenlDb29raWUgfVxuXG5pbXBvcnQgeyBDb29raWVKYXIsIFJlcXVlc3RKYXIsIHdyYXBDb29raWVKYXJGb3JSZXF1ZXN0LCBJUmVxdWVzdENvb2tpZUphciB9IGZyb20gJy4vY29va2llcyc7XG5leHBvcnQgeyBDb29raWVKYXIsIFJlcXVlc3RKYXIsIHdyYXBDb29raWVKYXJGb3JSZXF1ZXN0LCBJUmVxdWVzdENvb2tpZUphciB9XG5cbmV4cG9ydCB7IHBhcnNlQ29udGVudFR5cGUgfVxuZXhwb3J0IHsgVVJMLCBVUkxJbXBsIH1cblxuZXhwb3J0IHsgREVGQVVMVF9VU0VSX0FHRU5UIH0gZnJvbSAnLi9jb25zdCc7XG5pbXBvcnQgeyBERUZBVUxUX1VTRVJfQUdFTlQsIFNZTUJPTF9SQVcgfSBmcm9tICcuL2NvbnN0JztcblxuaW1wb3J0IHsgbWluaWZ5SFRNTCwgbm9ybWFsaXplSFRNTCB9IGZyb20gJy4vaHRtbCc7XG5cbmV4cG9ydCB7IHRvdWdoQ29va2llIH1cblxuZXhwb3J0IHR5cGUgSUNvb2tpZUphciA9IFBhcnRpYWw8Q29va2llSmFyPiB8IFBhcnRpYWw8TGF6eUNvb2tpZUphcj47XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUZyb21VcmxPcHRpb25zIGV4dGVuZHMgSU9wdGlvbnNKU0RPTVxue1xuXHRyZXF1ZXN0T3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyxcblx0Y29va2llSmFyPzogSUNvb2tpZUphciB8IFBhcnRpYWw8TGF6eUNvb2tpZUphcj4sXG5cblx0bGliUmVxdWVzdFByb21pc2U/LFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElSZXF1ZXN0T3B0aW9uc0pTRE9NIGV4dGVuZHMgUGFydGlhbDxyZXF1ZXN0LlJlcXVlc3RQcm9taXNlT3B0aW9ucz5cbntcblx0cmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U/OiBib29sZWFuO1xuXHRlbmNvZGluZz86IG51bGw7XG5cdGd6aXA/OiBib29sZWFuO1xuXHRoZWFkZXJzPzogQ29yZVJlcXVlc3QuSGVhZGVycyAmIHtcblx0XHRcIlVzZXItQWdlbnRcIj86IHN0cmluZztcblx0XHRSZWZlcmVyPzogc3RyaW5nO1xuXHRcdEFjY2VwdD86IHN0cmluZztcblx0XHRcIkFjY2VwdC1MYW5ndWFnZVwiPzogc3RyaW5nO1xuXHR9O1xuXHRqYXI/OiBJUmVxdWVzdEphcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmVxdWVzdE9wdGlvbnMgZXh0ZW5kcyBJUmVxdWVzdE9wdGlvbnNKU0RPTVxue1xuXHRtZXRob2Q/OiAnUE9TVCcgfCAnR0VUJyB8IHN0cmluZyxcblx0Zm9ybT86IHtcblx0XHRba2V5OiBzdHJpbmddOiBhbnksXG5cdFx0W2tleTogbnVtYmVyXTogYW55LFxuXHR9LFxufVxuXG5leHBvcnQgdHlwZSBJUmVxdWVzdEphciA9IFJlcXVlc3RDb29raWVKYXI7XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tVVJMKHVybDogc3RyaW5nIHwgVVJMLCBvcHRpb25zPzogSUZyb21VcmxPcHRpb25zKTogUHJvbWlzZTxJSlNET00+XG57XG5cdHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpXG5cdHtcblx0XHRjb25zdCBwYXJzZWRVUkwgPSBuZXcgVVJMKHVybCk7XG5cdFx0dXJsID0gcGFyc2VkVVJMLmhyZWYgYXMgc3RyaW5nO1xuXG5cdFx0bGV0IG9wdHMgPSB7fTtcblxuXHRcdG9wdGlvbnMgPSBwYWNrT3B0aW9ucyhvcHRpb25zLCBmdW5jdGlvbiAob3B0aW9ucylcblx0XHR7XG5cdFx0XHRvcHRzID0gb3B0aW9ucztcblx0XHR9KTtcblxuXHRcdG9wdGlvbnMgPSBub3JtYWxpemVGcm9tVVJMT3B0aW9ucyhvcHRpb25zKTtcblx0XHRsZXQgcmVxdWVzdE9wdGlvbnMgPSBub3JtYWxpemVSZXF1ZXN0T3B0aW9ucyhvcHRpb25zKTtcblxuXHRcdGxldCBfcmVxdWVzdCA9IG9wdGlvbnMubGliUmVxdWVzdFByb21pc2UgfHwgcmVxdWVzdDtcblxuXHRcdHJldHVybiBfcmVxdWVzdCh1cmwsIHJlcXVlc3RPcHRpb25zKVxuXHRcdFx0LnRoZW4oKHJlczogSVJlc3BvbnNlKSA9PlxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gcmVxdWVzdFRvSlNET00ocmVzLCBwYXJzZWRVUkwsIG9wdGlvbnMsIHJlcXVlc3RPcHRpb25zKTtcblx0XHRcdH0pXG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHQudGhlbihmdW5jdGlvbiAoanNkb206IElKU0RPTSlcblx0XHRcdHtcblx0XHRcdFx0aWYgKCFpc1BhY2tlZEpTRE9NKGpzZG9tKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHBhY2tKU0RPTShqc2RvbSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRqc2RvbS5fb3B0aW9ucy5Db25zdHJ1Y3Rvck9wdGlvbnMgPSBvcHRzO1xuXHRcdFx0XHRqc2RvbS5fb3B0aW9ucy5vcHRpb25zID0gb3B0aW9ucztcblx0XHRcdFx0anNkb20uX29wdGlvbnMucmVxdWVzdE9wdGlvbnMgPSByZXF1ZXN0T3B0aW9ucztcblxuXHRcdFx0XHRyZXR1cm4ganNkb20gYXMgSUpTRE9NO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3BvbnNlIGV4dGVuZHMgUmVzcG9uc2VSZXF1ZXN0XG57XG5cdGhlYWRlcnM6IHtcblx0XHRba2V5OiBzdHJpbmddOiBhbnksXG5cdH0sXG5cdHJlcXVlc3Q6IHtcblx0XHRocmVmPzogc3RyaW5nO1xuXHRcdFtrZXk6IHN0cmluZ106IGFueSxcblx0fVxuXHRib2R5OiBCdWZmZXIsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXF1ZXN0VG9KU0RPTTxUID0gSlNET00+KHJlczogSVJlc3BvbnNlLCBwYXJzZWRVUkw6IFVSTCB8IHN0cmluZywgb3B0aW9uczogUGFydGlhbDxJRnJvbVVybE9wdGlvbnM+LCByZXF1ZXN0T3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyk6IFRcbntcblx0aWYgKHR5cGVvZiBwYXJzZWRVUkwgPT0gJ3N0cmluZycpXG5cdHtcblx0XHRwYXJzZWRVUkwgPSBuZXcgVVJMKHBhcnNlZFVSTCk7XG5cdH1cblxuXHRsZXQgb3B0cyA9IHt9O1xuXG5cdG9wdGlvbnMgPSBwYWNrT3B0aW9ucyhvcHRpb25zLCBmdW5jdGlvbiAob3B0aW9ucylcblx0e1xuXHRcdG9wdHMgPSBvcHRpb25zO1xuXHR9KTtcblx0b3B0aW9ucyA9IG5vcm1hbGl6ZUZyb21VUkxPcHRpb25zKG9wdGlvbnMpO1xuXG5cdGNvbnN0IHBhcnNlZENvbnRlbnRUeXBlID0gcGFyc2VDb250ZW50VHlwZShyZXMuaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXSk7XG5cdGNvbnN0IHRyYW5zcG9ydExheWVyRW5jb2RpbmdMYWJlbCA9IHBhcnNlZENvbnRlbnRUeXBlICYmIHBhcnNlZENvbnRlbnRUeXBlLmdldChcImNoYXJzZXRcIik7XG5cblx0b3B0aW9ucyA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucywge1xuXHRcdHVybDogcmVzLnJlcXVlc3QuaHJlZiArIHBhcnNlZFVSTC5oYXNoLFxuXHRcdGNvbnRlbnRUeXBlOiByZXMuaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXSxcblx0XHRyZWZlcnJlcjogcmVzLnJlcXVlc3QuZ2V0SGVhZGVyKFwicmVmZXJlclwiKSxcblx0XHQvL1t0cmFuc3BvcnRMYXllckVuY29kaW5nTGFiZWxIaWRkZW5PcHRpb25dOiB0cmFuc3BvcnRMYXllckVuY29kaW5nTGFiZWxcblx0fSk7XG5cblx0bGV0IGJvZHkgPSBub3JtYWxpemVIVE1MKHJlcy5ib2R5LCB0cmFuc3BvcnRMYXllckVuY29kaW5nTGFiZWwpLmh0bWw7XG5cblx0aWYgKG9wdGlvbnMubWluaWZ5SFRNTClcblx0e1xuXHRcdGJvZHkgPSBtaW5pZnlIVE1MKGJvZHkpO1xuXHR9XG5cblx0bGV0IGpzZG9tID0gbmV3IEpTRE9NKGJvZHksIG9wdGlvbnMgYXMgSUNvbnN0cnVjdG9yT3B0aW9ucyk7XG5cblx0anNkb21bU1lNQk9MX1JBV10gPSBqc2RvbVtTWU1CT0xfUkFXXSB8fCB7fTtcblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucyA9IGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMgfHwge307XG5cdGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMub3B0aW9ucyA9IGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMub3B0aW9ucyB8fCBvcHRpb25zO1xuXHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLkNvbnN0cnVjdG9yT3B0aW9ucyA9IGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMuQ29uc3RydWN0b3JPcHRpb25zIHx8IG9wdHM7XG5cblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5SZXNwb25zZSA9IHJlcztcblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5ib2R5ID0gYm9keTtcblxuXHRpZiAocmVxdWVzdE9wdGlvbnMpXG5cdHtcblx0XHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLnJlcXVlc3RPcHRpb25zID0ganNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyB8fCByZXF1ZXN0T3B0aW9ucztcblx0fVxuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIGpzZG9tO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplUmVxdWVzdE9wdGlvbnMob3B0aW9uczogSUZyb21VcmxPcHRpb25zLCBfcmVxdWVzdE9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMpOiBQYXJ0aWFsPElSZXF1ZXN0T3B0aW9ucz5cbntcblx0Ly8gQHRzLWlnbm9yZVxuXHRsZXQgcmVxdWVzdE9wdGlvbnM6IFBhcnRpYWw8SVJlcXVlc3RPcHRpb25zPiA9IHtcblx0XHRyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcblx0XHRlbmNvZGluZzogbnVsbCwgLy8gaS5lLiwgZ2l2ZSBtZSB0aGUgcmF3IEJ1ZmZlclxuXHRcdGd6aXA6IHRydWUsXG5cdFx0aGVhZGVyczoge1xuXHRcdFx0XCJVc2VyLUFnZW50XCI6IG9wdGlvbnMudXNlckFnZW50IHx8IERFRkFVTFRfVVNFUl9BR0VOVCxcblx0XHRcdFJlZmVyZXI6IG9wdGlvbnMucmVmZXJyZXIsXG5cdFx0XHRBY2NlcHQ6IFwidGV4dC9odG1sLGFwcGxpY2F0aW9uL3hodG1sK3htbCxhcHBsaWNhdGlvbi94bWw7cT0wLjksKi8qO3E9MC44XCIsXG5cdFx0XHRcIkFjY2VwdC1MYW5ndWFnZVwiOiBcImVuXCJcblx0XHR9LFxuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRqYXI6IHdyYXBDb29raWVKYXJGb3JSZXF1ZXN0KG9wdGlvbnMuY29va2llSmFyKVxuXHR9O1xuXG5cdGlmIChvcHRpb25zLnJlcXVlc3RPcHRpb25zIHx8IF9yZXF1ZXN0T3B0aW9ucylcblx0e1xuXHRcdHJlcXVlc3RPcHRpb25zID0gZGVlcG1lcmdlLmFsbChbXG5cdFx0XHRyZXF1ZXN0T3B0aW9ucyxcblx0XHRcdG9wdGlvbnMucmVxdWVzdE9wdGlvbnMgfHwge30sXG5cdFx0XHRfcmVxdWVzdE9wdGlvbnMgfHwge30sXG5cdFx0XHR7XG5cdFx0XHRcdGVuY29kaW5nOiBudWxsLFxuXHRcdFx0fSxcblx0XHRdLCB7XG5cdFx0XHQvL2tleVZhbHVlT3JNb2RlOiB0cnVlLFxuXHRcdFx0aXNNZXJnZWFibGVPYmplY3QodmFsdWUsIGlzTWVyZ2VhYmxlKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgYm9vbCA9IGlzTWVyZ2VhYmxlKHZhbHVlKTtcblxuXHRcdFx0XHRpZiAoYm9vbCAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkodmFsdWUpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Ym9vbCA9IGlzUGxhaW5PYmplY3QodmFsdWUpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIGJvb2w7XG5cdFx0XHR9LFxuXHRcdH0pO1xuXHR9XG5cblx0cmV0dXJuIHJlcXVlc3RPcHRpb25zO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplRnJvbVVSTE9wdGlvbnM8VD4ob3B0aW9uczogUGFydGlhbDxUICYgSUZyb21VcmxPcHRpb25zPik6IFBhcnRpYWw8VCAmIElGcm9tVXJsT3B0aW9ucz5cbntcblx0Ly8gTm9ybWFsaXphdGlvbiBvZiBvcHRpb25zIHdoaWNoIG11c3QgYmUgZG9uZSBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGZyb21VUkwgY29kZSBjYW4gdXNlIHRoZW0sIGJlY2F1c2UgdGhleSBhcmVcblx0Ly8gZ2l2ZW4gdG8gcmVxdWVzdCgpXG5cdGNvbnN0IG5vcm1hbGl6ZWQ6IFBhcnRpYWw8VCAmIElGcm9tVXJsT3B0aW9ucz4gPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTtcblx0aWYgKG9wdGlvbnMudXNlckFnZW50ID09PSB1bmRlZmluZWQpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0bm9ybWFsaXplZC51c2VyQWdlbnQgPSBERUZBVUxUX1VTRVJfQUdFTlQ7XG5cdH1cblxuXHRpZiAob3B0aW9ucy5yZWZlcnJlciAhPT0gdW5kZWZpbmVkKVxuXHR7XG5cdFx0bm9ybWFsaXplZC5yZWZlcnJlciA9IChuZXcgVVJMKG9wdGlvbnMucmVmZXJyZXIpKS5ocmVmO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMuY29va2llSmFyID09PSB1bmRlZmluZWQpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0bm9ybWFsaXplZC5jb29raWVKYXIgPSBuZXcgTGF6eUNvb2tpZUphcigpO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRkZWxldGUgbm9ybWFsaXplZC51cmw7XG5cdC8vIEB0cy1pZ25vcmVcblx0ZGVsZXRlIG5vcm1hbGl6ZWQuY29udGVudFR5cGU7XG5cblx0cmV0dXJuIG5vcm1hbGl6ZWQ7XG5cblx0Ly8gQWxsIG90aGVyIG9wdGlvbnMgZG9uJ3QgbmVlZCB0byBiZSBwcm9jZXNzZWQgeWV0LCBhbmQgY2FuIGJlIHRha2VuIGNhcmUgb2YgaW4gdGhlIG5vcm1hbCBjb3Vyc2Ugb2YgdGhpbmdzIHdoZW5cblx0Ly8gYGZyb21VUkxgIGNhbGxzIGBuZXcgSlNET00oaHRtbCwgb3B0aW9ucylgLlxufVxuXG5cblxuaW1wb3J0ICogYXMgc2VsZiBmcm9tICcuL2Zyb20tdXJsJ1xuXG5leHBvcnQgZGVmYXVsdCBzZWxmO1xuIl19