"use strict";
/**
 * Created by user on 2018/2/6/006.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const jsdom_1 = require("jsdom");
exports.toughCookie = jsdom_1.toughCookie;
const deepmerge = require("deepmerge-plus");
const pack_1 = require("./pack");
const jsdom_url_1 = require("jsdom-url");
exports.URL = jsdom_url_1.URL;
exports.URLImpl = jsdom_url_1.URLImpl;
const index_1 = require("./index");
const parseContentType = require("content-type-parser");
exports.parseContentType = parseContentType;
const isPlainObject = require("is-plain-object");
const cookies_1 = require("./cookies");
exports.LazyCookieJar = cookies_1.LazyCookieJar;
exports.LazyCookie = cookies_1.LazyCookie;
const cookies_2 = require("./cookies");
exports.CookieJar = cookies_2.CookieJar;
exports.RequestJar = cookies_2.RequestJar;
exports.wrapCookieJarForRequest = cookies_2.wrapCookieJarForRequest;
var const_1 = require("./const");
exports.DEFAULT_USER_AGENT = const_1.DEFAULT_USER_AGENT;
const const_2 = require("./const");
const html_1 = require("./html");
function fromURL(url, options) {
    return index_1.Promise.resolve().then(function () {
        const parsedURL = new jsdom_url_1.URL(url);
        url = parsedURL.href;
        let opts = {};
        options = pack_1.packOptions(options, function (options) {
            opts = options;
        });
        options = normalizeFromURLOptions(options);
        let requestOptions = normalizeRequestOptions(options);
        let _request = options.libRequestPromise || index_1.request;
        return _request(url, requestOptions)
            .then((res) => {
            // @ts-ignore
            return requestToJSDOM(res, parsedURL, options, requestOptions);
        })
            // @ts-ignore
            .then(function (jsdom) {
            if (!pack_1.isPackedJSDOM(jsdom)) {
                pack_1.packJSDOM(jsdom);
            }
            jsdom._options.ConstructorOptions = opts;
            jsdom._options.options = options;
            jsdom._options.requestOptions = requestOptions;
            return jsdom;
        });
    });
}
exports.fromURL = fromURL;
function requestToJSDOM(res, parsedURL, options, requestOptions) {
    if (typeof parsedURL == 'string') {
        // @ts-ignore
        parsedURL = new jsdom_url_1.URL(parsedURL);
    }
    let opts = {};
    options = pack_1.packOptions(options, function (options) {
        opts = options;
    });
    options = normalizeFromURLOptions(options);
    const parsedContentType = parseContentType(res.headers["content-type"]);
    const transportLayerEncodingLabel = parsedContentType && parsedContentType.get("charset");
    options = Object.assign(options, {
        // @ts-ignore
        url: res.request.href + parsedURL.hash,
        contentType: res.headers["content-type"],
        referrer: res.request.getHeader("referer"),
    });
    let body = html_1.normalizeHTML(res.body, transportLayerEncodingLabel).html;
    if (options.minifyHTML) {
        body = html_1.minifyHTML(body);
    }
    let jsdom = new jsdom_1.JSDOM(body, options);
    jsdom[const_2.SYMBOL_RAW] = jsdom[const_2.SYMBOL_RAW] || {};
    jsdom[const_2.SYMBOL_RAW].options = jsdom[const_2.SYMBOL_RAW].options || {};
    jsdom[const_2.SYMBOL_RAW].options.options = jsdom[const_2.SYMBOL_RAW].options.options || options;
    jsdom[const_2.SYMBOL_RAW].options.ConstructorOptions = jsdom[const_2.SYMBOL_RAW].options.ConstructorOptions || opts;
    jsdom[const_2.SYMBOL_RAW].options.Response = res;
    jsdom[const_2.SYMBOL_RAW].options.body = body;
    if (requestOptions) {
        jsdom[const_2.SYMBOL_RAW].options.requestOptions = jsdom[const_2.SYMBOL_RAW].options.requestOptions || requestOptions;
    }
    // @ts-ignore
    return jsdom;
}
exports.requestToJSDOM = requestToJSDOM;
function normalizeRequestOptions(options, _requestOptions) {
    // @ts-ignore
    let requestOptions = {
        resolveWithFullResponse: true,
        encoding: null,
        gzip: true,
        headers: {
            "User-Agent": options.userAgent || const_2.DEFAULT_USER_AGENT,
            // @ts-ignore
            Referer: options.referrer,
            Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Language": "en"
        },
        // @ts-ignore
        jar: cookies_2.wrapCookieJarForRequest(options.cookieJar)
    };
    if (options.requestOptions || _requestOptions) {
        requestOptions = deepmerge.all([
            requestOptions,
            options.requestOptions || {},
            _requestOptions || {},
            {
                encoding: null,
            },
        ], {
            //keyValueOrMode: true,
            isMergeableObject(value, isMergeable) {
                let bool = isMergeable(value);
                if (bool && typeof value == 'object' && !Array.isArray(value)) {
                    // @ts-ignore
                    bool = isPlainObject(value);
                }
                return bool;
            },
        });
    }
    return requestOptions;
}
exports.normalizeRequestOptions = normalizeRequestOptions;
function normalizeFromURLOptions(options) {
    // Normalization of options which must be done before the rest of the fromURL code can use them, because they are
    // given to request()
    const normalized = Object.assign({}, options);
    if (options.userAgent === undefined) {
        // @ts-ignore
        normalized.userAgent = const_2.DEFAULT_USER_AGENT;
    }
    if (options.referrer !== undefined) {
        // @ts-ignore
        normalized.referrer = (new jsdom_url_1.URL(options.referrer)).href;
    }
    if (options.cookieJar === undefined) {
        // @ts-ignore
        normalized.cookieJar = new cookies_1.LazyCookieJar();
    }
    // @ts-ignore
    delete normalized.url;
    // @ts-ignore
    delete normalized.contentType;
    return normalized;
    // All other options don't need to be processed yet, and can be taken care of in the normal course of things when
    // `fromURL` calls `new JSDOM(html, options)`.
}
exports.normalizeFromURLOptions = normalizeFromURLOptions;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJvbS11cmwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmcm9tLXVybC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBR0gsaUNBQTJEO0FBd0JsRCxzQkF4QnVCLG1CQUFXLENBd0J2QjtBQXZCcEIsNENBQTZDO0FBRTdDLGlDQUFxSDtBQUNySCx5Q0FBeUM7QUFhaEMsY0FiQSxlQUFHLENBYUE7QUFBRSxrQkFiQSxtQkFBTyxDQWFBO0FBWnJCLG1DQUE0RDtBQUM1RCx3REFBeUQ7QUFVaEQsNENBQWdCO0FBVHpCLGlEQUFrRDtBQUdsRCx1Q0FBd0U7QUFDL0Qsd0JBREEsdUJBQWEsQ0FDQTtBQUFFLHFCQURBLG9CQUFVLENBQ0E7QUFFbEMsdUNBQThGO0FBQ3JGLG9CQURBLG1CQUFTLENBQ0E7QUFBRSxxQkFEQSxvQkFBVSxDQUNBO0FBQUUsa0NBREEsaUNBQXVCLENBQ0E7QUFLdkQsaUNBQTZDO0FBQXBDLHFDQUFBLGtCQUFrQixDQUFBO0FBQzNCLG1DQUF5RDtBQUV6RCxpQ0FBbUQ7QUF1Q25ELFNBQWdCLE9BQU8sQ0FBQyxHQUFpQixFQUFFLE9BQXlCO0lBRW5FLE9BQU8sZUFBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQztRQUU3QixNQUFNLFNBQVMsR0FBRyxJQUFJLGVBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixHQUFHLEdBQUcsU0FBUyxDQUFDLElBQWMsQ0FBQztRQUUvQixJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFFZCxPQUFPLEdBQUcsa0JBQVcsQ0FBQyxPQUFPLEVBQUUsVUFBVSxPQUFPO1lBRS9DLElBQUksR0FBRyxPQUFPLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0MsSUFBSSxjQUFjLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdEQsSUFBSSxRQUFRLEdBQUcsT0FB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Q0FBOEM7QUFDL0MsQ0FBQztBQWhDRCwwREFnQ0M7QUFFRCxrQkFBZSxPQUFzQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC8yLzYvMDA2LlxuICovXG5cbmltcG9ydCBDb3JlUmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbmltcG9ydCB7IEpTRE9NLCBGcm9tVXJsT3B0aW9ucywgdG91Z2hDb29raWUgfSBmcm9tICdqc2RvbSc7XG5pbXBvcnQgZGVlcG1lcmdlID0gcmVxdWlyZSgnZGVlcG1lcmdlLXBsdXMnKTtcblxuaW1wb3J0IHsgSUNvbnN0cnVjdG9yT3B0aW9ucywgSUpTRE9NLCBJT3B0aW9ucywgSU9wdGlvbnNKU0RPTSwgaXNQYWNrZWRKU0RPTSwgcGFja0pTRE9NLCBwYWNrT3B0aW9ucyB9IGZyb20gJy4vcGFjayc7XG5pbXBvcnQgeyBVUkwsIFVSTEltcGwgfSBmcm9tICdqc2RvbS11cmwnO1xuaW1wb3J0IHsgUHJvbWlzZSwgcmVxdWVzdCwgUmVzcG9uc2VSZXF1ZXN0IH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgcGFyc2VDb250ZW50VHlwZSA9IHJlcXVpcmUoJ2NvbnRlbnQtdHlwZS1wYXJzZXInKTtcbmltcG9ydCBpc1BsYWluT2JqZWN0ID0gcmVxdWlyZSgnaXMtcGxhaW4tb2JqZWN0Jyk7XG5pbXBvcnQgeyBJT3B0aW9uc1dpdGhXaW5kb3dPcHRpb25zV2l0aFJlc291cmNlTG9hZGVyIH0gZnJvbSAnLi9icm93c2VyL3Jlc291cmNlLWxvYWRlcic7XG5cbmltcG9ydCB7IExhenlDb29raWVKYXIsIExhenlDb29raWUsIFJlcXVlc3RDb29raWVKYXIgfSBmcm9tICcuL2Nvb2tpZXMnO1xuZXhwb3J0IHsgTGF6eUNvb2tpZUphciwgTGF6eUNvb2tpZSB9XG5cbmltcG9ydCB7IENvb2tpZUphciwgUmVxdWVzdEphciwgd3JhcENvb2tpZUphckZvclJlcXVlc3QsIElSZXF1ZXN0Q29va2llSmFyIH0gZnJvbSAnLi9jb29raWVzJztcbmV4cG9ydCB7IENvb2tpZUphciwgUmVxdWVzdEphciwgd3JhcENvb2tpZUphckZvclJlcXVlc3QsIElSZXF1ZXN0Q29va2llSmFyIH1cblxuZXhwb3J0IHsgcGFyc2VDb250ZW50VHlwZSB9XG5leHBvcnQgeyBVUkwsIFVSTEltcGwgfVxuXG5leHBvcnQgeyBERUZBVUxUX1VTRVJfQUdFTlQgfSBmcm9tICcuL2NvbnN0JztcbmltcG9ydCB7IERFRkFVTFRfVVNFUl9BR0VOVCwgU1lNQk9MX1JBVyB9IGZyb20gJy4vY29uc3QnO1xuXG5pbXBvcnQgeyBtaW5pZnlIVE1MLCBub3JtYWxpemVIVE1MIH0gZnJvbSAnLi9odG1sJztcblxuZXhwb3J0IHsgdG91Z2hDb29raWUgfVxuXG5leHBvcnQgdHlwZSBJQ29va2llSmFyID0gUGFydGlhbDxDb29raWVKYXI+IHwgUGFydGlhbDxMYXp5Q29va2llSmFyPjtcblxuZXhwb3J0IGludGVyZmFjZSBJRnJvbVVybE9wdGlvbnMgZXh0ZW5kcyBJT3B0aW9uc0pTRE9NXG57XG5cdHJlcXVlc3RPcHRpb25zPzogSVJlcXVlc3RPcHRpb25zLFxuXHRjb29raWVKYXI/OiBJQ29va2llSmFyIHwgUGFydGlhbDxMYXp5Q29va2llSmFyPixcblxuXHRsaWJSZXF1ZXN0UHJvbWlzZT8sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlcXVlc3RPcHRpb25zSlNET00gZXh0ZW5kcyBQYXJ0aWFsPHJlcXVlc3QuUmVxdWVzdFByb21pc2VPcHRpb25zPlxue1xuXHRyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZT86IGJvb2xlYW47XG5cdGVuY29kaW5nPzogbnVsbDtcblx0Z3ppcD86IGJvb2xlYW47XG5cdGhlYWRlcnM/OiBDb3JlUmVxdWVzdC5IZWFkZXJzICYge1xuXHRcdFwiVXNlci1BZ2VudFwiPzogc3RyaW5nO1xuXHRcdFJlZmVyZXI/OiBzdHJpbmc7XG5cdFx0QWNjZXB0Pzogc3RyaW5nO1xuXHRcdFwiQWNjZXB0LUxhbmd1YWdlXCI/OiBzdHJpbmc7XG5cdH07XG5cdGphcj86IElSZXF1ZXN0SmFyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElSZXF1ZXN0T3B0aW9ucyBleHRlbmRzIElSZXF1ZXN0T3B0aW9uc0pTRE9NXG57XG5cdG1ldGhvZD86ICdQT1NUJyB8ICdHRVQnIHwgc3RyaW5nLFxuXHRmb3JtPzoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueSxcblx0XHRba2V5OiBudW1iZXJdOiBhbnksXG5cdH0sXG59XG5cbmV4cG9ydCB0eXBlIElSZXF1ZXN0SmFyID0gUmVxdWVzdENvb2tpZUphcjtcblxuZXhwb3J0IGZ1bmN0aW9uIGZyb21VUkwodXJsOiBzdHJpbmcgfCBVUkwsIG9wdGlvbnM/OiBJRnJvbVVybE9wdGlvbnMpOiBQcm9taXNlPElKU0RPTT5cbntcblx0cmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKClcblx0e1xuXHRcdGNvbnN0IHBhcnNlZFVSTCA9IG5ldyBVUkwodXJsKTtcblx0XHR1cmwgPSBwYXJzZWRVUkwuaHJlZiBhcyBzdHJpbmc7XG5cblx0XHRsZXQgb3B0cyA9IHt9O1xuXG5cdFx0b3B0aW9ucyA9IHBhY2tPcHRpb25zKG9wdGlvbnMsIGZ1bmN0aW9uIChvcHRpb25zKVxuXHRcdHtcblx0XHRcdG9wdHMgPSBvcHRpb25zO1xuXHRcdH0pO1xuXG5cdFx0b3B0aW9ucyA9IG5vcm1hbGl6ZUZyb21VUkxPcHRpb25zKG9wdGlvbnMpO1xuXHRcdGxldCByZXF1ZXN0T3B0aW9ucyA9IG5vcm1hbGl6ZVJlcXVlc3RPcHRpb25zKG9wdGlvbnMpO1xuXG5cdFx0bGV0IF9yZXF1ZXN0ID0gb3B0aW9ucy5saWJSZXF1ZXN0UHJvbWlzZSB8fCByZXF1ZXN0O1xuXG5cdFx0cmV0dXJuIF9yZXF1ZXN0KHVybCwgcmVxdWVzdE9wdGlvbnMpXG5cdFx0XHQudGhlbigocmVzOiBJUmVzcG9uc2UpID0+XG5cdFx0XHR7XG5cdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFx0cmV0dXJuIHJlcXVlc3RUb0pTRE9NKHJlcywgcGFyc2VkVVJMLCBvcHRpb25zLCByZXF1ZXN0T3B0aW9ucyk7XG5cdFx0XHR9KVxuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKGpzZG9tOiBJSlNET00pXG5cdFx0XHR7XG5cdFx0XHRcdGlmICghaXNQYWNrZWRKU0RPTShqc2RvbSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRwYWNrSlNET00oanNkb20pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0anNkb20uX29wdGlvbnMuQ29uc3RydWN0b3JPcHRpb25zID0gb3B0cztcblx0XHRcdFx0anNkb20uX29wdGlvbnMub3B0aW9ucyA9IG9wdGlvbnM7XG5cdFx0XHRcdGpzZG9tLl9vcHRpb25zLnJlcXVlc3RPcHRpb25zID0gcmVxdWVzdE9wdGlvbnM7XG5cblx0XHRcdFx0cmV0dXJuIGpzZG9tIGFzIElKU0RPTTtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH0pO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElSZXNwb25zZSBleHRlbmRzIE9taXQ8UmVzcG9uc2VSZXF1ZXN0LCAnYm9keSc+XG57XG5cdGhlYWRlcnM6IHtcblx0XHRba2V5OiBzdHJpbmddOiBhbnksXG5cdH0sXG5cdHJlcXVlc3Q6IHtcblx0XHRocmVmPzogc3RyaW5nO1xuXHRcdFtrZXk6IHN0cmluZ106IGFueSxcblx0fVxuXHRib2R5OiBCdWZmZXIgfCBzdHJpbmcsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXF1ZXN0VG9KU0RPTTxUID0gSlNET00+KHJlczogSVJlc3BvbnNlLCBwYXJzZWRVUkw6IFVSTCB8IHN0cmluZywgb3B0aW9uczogUGFydGlhbDxJRnJvbVVybE9wdGlvbnM+LCByZXF1ZXN0T3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyk6IFRcbntcblx0aWYgKHR5cGVvZiBwYXJzZWRVUkwgPT0gJ3N0cmluZycpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0cGFyc2VkVVJMID0gbmV3IFVSTChwYXJzZWRVUkwpO1xuXHR9XG5cblx0bGV0IG9wdHMgPSB7fTtcblxuXHRvcHRpb25zID0gcGFja09wdGlvbnMob3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbnMpXG5cdHtcblx0XHRvcHRzID0gb3B0aW9ucztcblx0fSk7XG5cdG9wdGlvbnMgPSBub3JtYWxpemVGcm9tVVJMT3B0aW9ucyhvcHRpb25zKTtcblxuXHRjb25zdCBwYXJzZWRDb250ZW50VHlwZSA9IHBhcnNlQ29udGVudFR5cGUocmVzLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0pO1xuXHRjb25zdCB0cmFuc3BvcnRMYXllckVuY29kaW5nTGFiZWwgPSBwYXJzZWRDb250ZW50VHlwZSAmJiBwYXJzZWRDb250ZW50VHlwZS5nZXQoXCJjaGFyc2V0XCIpO1xuXG5cdG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKG9wdGlvbnMsIHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0dXJsOiByZXMucmVxdWVzdC5ocmVmICsgcGFyc2VkVVJMLmhhc2gsXG5cdFx0Y29udGVudFR5cGU6IHJlcy5oZWFkZXJzW1wiY29udGVudC10eXBlXCJdLFxuXHRcdHJlZmVycmVyOiByZXMucmVxdWVzdC5nZXRIZWFkZXIoXCJyZWZlcmVyXCIpLFxuXHRcdC8vW3RyYW5zcG9ydExheWVyRW5jb2RpbmdMYWJlbEhpZGRlbk9wdGlvbl06IHRyYW5zcG9ydExheWVyRW5jb2RpbmdMYWJlbFxuXHR9KTtcblxuXHRsZXQgYm9keSA9IG5vcm1hbGl6ZUhUTUwocmVzLmJvZHkgYXMgYW55LCB0cmFuc3BvcnRMYXllckVuY29kaW5nTGFiZWwpLmh0bWw7XG5cblx0aWYgKG9wdGlvbnMubWluaWZ5SFRNTClcblx0e1xuXHRcdGJvZHkgPSBtaW5pZnlIVE1MKGJvZHkpO1xuXHR9XG5cblx0bGV0IGpzZG9tID0gbmV3IEpTRE9NKGJvZHksIG9wdGlvbnMgYXMgSUNvbnN0cnVjdG9yT3B0aW9ucyk7XG5cblx0anNkb21bU1lNQk9MX1JBV10gPSBqc2RvbVtTWU1CT0xfUkFXXSB8fCB7fTtcblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucyA9IGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMgfHwge307XG5cdGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMub3B0aW9ucyA9IGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMub3B0aW9ucyB8fCBvcHRpb25zO1xuXHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLkNvbnN0cnVjdG9yT3B0aW9ucyA9IGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMuQ29uc3RydWN0b3JPcHRpb25zIHx8IG9wdHM7XG5cblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5SZXNwb25zZSA9IHJlcztcblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5ib2R5ID0gYm9keTtcblxuXHRpZiAocmVxdWVzdE9wdGlvbnMpXG5cdHtcblx0XHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLnJlcXVlc3RPcHRpb25zID0ganNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyB8fCByZXF1ZXN0T3B0aW9ucztcblx0fVxuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIGpzZG9tO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplUmVxdWVzdE9wdGlvbnMob3B0aW9uczogSUZyb21VcmxPcHRpb25zLCBfcmVxdWVzdE9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMpOiBQYXJ0aWFsPElSZXF1ZXN0T3B0aW9ucz5cbntcblx0Ly8gQHRzLWlnbm9yZVxuXHRsZXQgcmVxdWVzdE9wdGlvbnM6IFBhcnRpYWw8SVJlcXVlc3RPcHRpb25zPiA9IHtcblx0XHRyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcblx0XHRlbmNvZGluZzogbnVsbCwgLy8gaS5lLiwgZ2l2ZSBtZSB0aGUgcmF3IEJ1ZmZlclxuXHRcdGd6aXA6IHRydWUsXG5cdFx0aGVhZGVyczoge1xuXHRcdFx0XCJVc2VyLUFnZW50XCI6IG9wdGlvbnMudXNlckFnZW50IHx8IERFRkFVTFRfVVNFUl9BR0VOVCxcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFJlZmVyZXI6IG9wdGlvbnMucmVmZXJyZXIsXG5cdFx0XHRBY2NlcHQ6IFwidGV4dC9odG1sLGFwcGxpY2F0aW9uL3hodG1sK3htbCxhcHBsaWNhdGlvbi94bWw7cT0wLjksKi8qO3E9MC44XCIsXG5cdFx0XHRcIkFjY2VwdC1MYW5ndWFnZVwiOiBcImVuXCJcblx0XHR9LFxuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRqYXI6IHdyYXBDb29raWVKYXJGb3JSZXF1ZXN0KG9wdGlvbnMuY29va2llSmFyKVxuXHR9O1xuXG5cdGlmIChvcHRpb25zLnJlcXVlc3RPcHRpb25zIHx8IF9yZXF1ZXN0T3B0aW9ucylcblx0e1xuXHRcdHJlcXVlc3RPcHRpb25zID0gZGVlcG1lcmdlLmFsbChbXG5cdFx0XHRyZXF1ZXN0T3B0aW9ucyxcblx0XHRcdG9wdGlvbnMucmVxdWVzdE9wdGlvbnMgfHwge30sXG5cdFx0XHRfcmVxdWVzdE9wdGlvbnMgfHwge30sXG5cdFx0XHR7XG5cdFx0XHRcdGVuY29kaW5nOiBudWxsLFxuXHRcdFx0fSxcblx0XHRdLCB7XG5cdFx0XHQvL2tleVZhbHVlT3JNb2RlOiB0cnVlLFxuXHRcdFx0aXNNZXJnZWFibGVPYmplY3QodmFsdWUsIGlzTWVyZ2VhYmxlKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgYm9vbCA9IGlzTWVyZ2VhYmxlKHZhbHVlKTtcblxuXHRcdFx0XHRpZiAoYm9vbCAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkodmFsdWUpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdGJvb2wgPSBpc1BsYWluT2JqZWN0KHZhbHVlKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiBib29sO1xuXHRcdFx0fSxcblx0XHR9KTtcblx0fVxuXG5cdHJldHVybiByZXF1ZXN0T3B0aW9ucztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZUZyb21VUkxPcHRpb25zPFQ+KG9wdGlvbnM6IFBhcnRpYWw8VCAmIElGcm9tVXJsT3B0aW9ucz4pOiBQYXJ0aWFsPFQgJiBJRnJvbVVybE9wdGlvbnM+XG57XG5cdC8vIE5vcm1hbGl6YXRpb24gb2Ygb3B0aW9ucyB3aGljaCBtdXN0IGJlIGRvbmUgYmVmb3JlIHRoZSByZXN0IG9mIHRoZSBmcm9tVVJMIGNvZGUgY2FuIHVzZSB0aGVtLCBiZWNhdXNlIHRoZXkgYXJlXG5cdC8vIGdpdmVuIHRvIHJlcXVlc3QoKVxuXHRjb25zdCBub3JtYWxpemVkOiBQYXJ0aWFsPFQgJiBJRnJvbVVybE9wdGlvbnM+ID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyk7XG5cdGlmIChvcHRpb25zLnVzZXJBZ2VudCA9PT0gdW5kZWZpbmVkKVxuXHR7XG5cdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdG5vcm1hbGl6ZWQudXNlckFnZW50ID0gREVGQVVMVF9VU0VSX0FHRU5UO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMucmVmZXJyZXIgIT09IHVuZGVmaW5lZClcblx0e1xuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRub3JtYWxpemVkLnJlZmVycmVyID0gKG5ldyBVUkwob3B0aW9ucy5yZWZlcnJlcikpLmhyZWY7XG5cdH1cblxuXHRpZiAob3B0aW9ucy5jb29raWVKYXIgPT09IHVuZGVmaW5lZClcblx0e1xuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRub3JtYWxpemVkLmNvb2tpZUphciA9IG5ldyBMYXp5Q29va2llSmFyKCk7XG5cdH1cblxuXHQvLyBAdHMtaWdub3JlXG5cdGRlbGV0ZSBub3JtYWxpemVkLnVybDtcblx0Ly8gQHRzLWlnbm9yZVxuXHRkZWxldGUgbm9ybWFsaXplZC5jb250ZW50VHlwZTtcblxuXHRyZXR1cm4gbm9ybWFsaXplZDtcblxuXHQvLyBBbGwgb3RoZXIgb3B0aW9ucyBkb24ndCBuZWVkIHRvIGJlIHByb2Nlc3NlZCB5ZXQsIGFuZCBjYW4gYmUgdGFrZW4gY2FyZSBvZiBpbiB0aGUgbm9ybWFsIGNvdXJzZSBvZiB0aGluZ3Mgd2hlblxuXHQvLyBgZnJvbVVSTGAgY2FsbHMgYG5ldyBKU0RPTShodG1sLCBvcHRpb25zKWAuXG59XG5cbmV4cG9ydCBkZWZhdWx0IGV4cG9ydHMgYXMgdHlwZW9mIGltcG9ydCgnLi9mcm9tLXVybCcpO1xuIl19