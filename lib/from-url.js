"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const jsdom_1 = require("jsdom");
exports.toughCookie = jsdom_1.toughCookie;
const deepmerge = require("deepmerge-plus");
const pack_1 = require("./pack");
exports.URL = pack_1.URL;
exports.URLImpl = pack_1.URLImpl;
const index_1 = require("./index");
const parseContentType = require("content-type-parser");
exports.parseContentType = parseContentType;
const isPlainObject = require("is-plain-object");
const cookies_1 = require("./cookies");
exports.LazyCookieJar = cookies_1.LazyCookieJar;
exports.LazyCookie = cookies_1.LazyCookie;
const cookies_2 = require("./cookies");
exports.CookieJar = cookies_2.CookieJar;
exports.RequestJar = cookies_2.RequestJar;
exports.wrapCookieJarForRequest = cookies_2.wrapCookieJarForRequest;
var const_1 = require("./const");
exports.DEFAULT_USER_AGENT = const_1.DEFAULT_USER_AGENT;
const const_2 = require("./const");
const html_1 = require("./html");
function fromURL(url, options) {
    return index_1.Promise.resolve().then(function () {
        const parsedURL = new pack_1.URL(url);
        url = parsedURL.href;
        let opts = {};
        options = pack_1.packOptions(options, function (options) {
            opts = options;
        });
        options = normalizeFromURLOptions(options);
        let requestOptions = normalizeRequestOptions(options);
        let _request = options.libRequestPromise || index_1.request;
        return _request(url, requestOptions)
            .then((res) => {
            return requestToJSDOM(res, parsedURL, options, requestOptions);
        })
            .then(function (jsdom) {
            if (!pack_1.isPackedJSDOM(jsdom)) {
                pack_1.packJSDOM(jsdom);
            }
            jsdom._options.ConstructorOptions = opts;
            jsdom._options.options = options;
            jsdom._options.requestOptions = requestOptions;
            return jsdom;
        });
    });
}
exports.fromURL = fromURL;
function requestToJSDOM(res, parsedURL, options, requestOptions) {
    if (typeof parsedURL == 'string') {
        parsedURL = new pack_1.URL(parsedURL);
    }
    let opts = {};
    options = pack_1.packOptions(options, function (options) {
        opts = options;
    });
    options = normalizeFromURLOptions(options);
    const parsedContentType = parseContentType(res.headers["content-type"]);
    const transportLayerEncodingLabel = parsedContentType && parsedContentType.get("charset");
    options = Object.assign(options, {
        url: res.request.href + parsedURL.hash,
        contentType: res.headers["content-type"],
        referrer: res.request.getHeader("referer"),
    });
    let body = html_1.normalizeHTML(res.body, transportLayerEncodingLabel).html;
    if (options.minifyHTML) {
        body = html_1.minifyHTML(body);
    }
    let jsdom = new jsdom_1.JSDOM(body, options);
    jsdom[const_2.SYMBOL_RAW] = jsdom[const_2.SYMBOL_RAW] || {};
    jsdom[const_2.SYMBOL_RAW].options = jsdom[const_2.SYMBOL_RAW].options || {};
    jsdom[const_2.SYMBOL_RAW].options.options = jsdom[const_2.SYMBOL_RAW].options.options || options;
    jsdom[const_2.SYMBOL_RAW].options.ConstructorOptions = jsdom[const_2.SYMBOL_RAW].options.ConstructorOptions || opts;
    jsdom[const_2.SYMBOL_RAW].options.Response = res;
    jsdom[const_2.SYMBOL_RAW].options.body = body;
    if (requestOptions) {
        jsdom[const_2.SYMBOL_RAW].options.requestOptions = jsdom[const_2.SYMBOL_RAW].options.requestOptions || requestOptions;
    }
    return jsdom;
}
exports.requestToJSDOM = requestToJSDOM;
function normalizeRequestOptions(options, _requestOptions) {
    let requestOptions = {
        resolveWithFullResponse: true,
        encoding: null,
        gzip: true,
        headers: {
            "User-Agent": options.userAgent || const_2.DEFAULT_USER_AGENT,
            Referer: options.referrer,
            Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Language": "en"
        },
        jar: cookies_2.wrapCookieJarForRequest(options.cookieJar)
    };
    if (options.requestOptions || _requestOptions) {
        requestOptions = deepmerge.all([
            requestOptions,
            options.requestOptions || {},
            _requestOptions || {},
            {
                encoding: null,
            },
        ], {
            isMergeableObject(value, isMergeable) {
                let bool = isMergeable(value);
                if (bool && typeof value == 'object' && !Array.isArray(value)) {
                    bool = isPlainObject(value);
                }
                return bool;
            },
        });
    }
    return requestOptions;
}
exports.normalizeRequestOptions = normalizeRequestOptions;
function normalizeFromURLOptions(options) {
    const normalized = Object.assign({}, options);
    if (options.userAgent === undefined) {
        normalized.userAgent = const_2.DEFAULT_USER_AGENT;
    }
    if (options.referrer !== undefined) {
        normalized.referrer = (new pack_1.URL(options.referrer)).href;
    }
    if (options.cookieJar === undefined) {
        normalized.cookieJar = new cookies_1.LazyCookieJar();
    }
    delete normalized.url;
    delete normalized.contentType;
    return normalized;
}
exports.normalizeFromURLOptions = normalizeFromURLOptions;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJvbS11cmwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmcm9tLXVybC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLGlDQUEyRDtBQXVCbEQsc0JBdkJ1QixtQkFBVyxDQXVCdkI7QUF0QnBCLDRDQUE2QztBQUU3QyxpQ0FBbUk7QUFhMUgsY0FiNkYsVUFBRyxDQWE3RjtBQUFFLGtCQWI2RixjQUFPLENBYTdGO0FBWnJCLG1DQUE0RDtBQUM1RCx3REFBeUQ7QUFVaEQsNENBQWdCO0FBVHpCLGlEQUFrRDtBQUdsRCx1Q0FBd0U7QUFDL0Qsd0JBREEsdUJBQWEsQ0FDQTtBQUFFLHFCQURBLG9CQUFVLENBQ0E7QUFFbEMsdUNBQThGO0FBQ3JGLG9CQURBLG1CQUFTLENBQ0E7QUFBRSxxQkFEQSxvQkFBVSxDQUNBO0FBQUUsa0NBREEsaUNBQXVCLENBQ0E7QUFLdkQsaUNBQTZDO0FBQXBDLHFDQUFBLGtCQUFrQixDQUFBO0FBQzNCLG1DQUF5RDtBQUV6RCxpQ0FBbUQ7QUF1Q25ELFNBQWdCLE9BQU8sQ0FBQyxHQUFpQixFQUFFLE9BQXlCO0lBRW5FLE9BQU8sZUFBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQztRQUU3QixNQUFNLFNBQVMsR0FBRyxJQUFJLFVBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixHQUFHLEdBQUcsU0FBUyxDQUFDLElBQWMsQ0FBQztRQUUvQixJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFFZCxPQUFPLEdBQUcsa0JBQVcsQ0FBQyxPQUFPLEVBQUUsVUFBVSxPQUFPO1lBRS9DLElBQUksR0FBRyxPQUFPLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0MsSUFBSSxjQUFjLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdEQsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixJQUFJLGVB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USxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFDN0Q7b0JBQ0MsSUFBSSxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDNUI7Z0JBRUQsT0FBTyxJQUFJLENBQUM7WUFDYixDQUFDO1NBQ0QsQ0FBQyxDQUFDO0tBQ0g7SUFFRCxPQUFPLGNBQWMsQ0FBQztBQUN2QixDQUFDO0FBNUNELDBEQTRDQztBQUVELFNBQWdCLHVCQUF1QixDQUFJLE9BQXFDO0lBSS9FLE1BQU0sVUFBVSxHQUFpQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1RSxJQUFJLE9BQU8sQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUNuQztRQUVDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsMEJBQWtCLENBQUM7S0FDMUM7SUFFRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUNsQztRQUVDLFVBQVUsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLFVBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7S0FDdkQ7SUFFRCxJQUFJLE9BQU8sQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUNuQztRQUVDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsSUFBSSx1QkFBYSxFQUFFLENBQUM7S0FDM0M7SUFHRCxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUM7SUFFdEIsT0FBTyxVQUFVLENBQUMsV0FBVyxDQUFDO0lBRTlCLE9BQU8sVUFBVSxDQUFDO0FBSW5CLENBQUM7QUFoQ0QsMERBZ0NDO0FBRUQsa0JBQWUsT0FBc0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvMi82LzAwNi5cbiAqL1xuXG5pbXBvcnQgQ29yZVJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG5pbXBvcnQgeyBKU0RPTSwgRnJvbVVybE9wdGlvbnMsIHRvdWdoQ29va2llIH0gZnJvbSAnanNkb20nO1xuaW1wb3J0IGRlZXBtZXJnZSA9IHJlcXVpcmUoJ2RlZXBtZXJnZS1wbHVzJyk7XG5cbmltcG9ydCB7IElDb25zdHJ1Y3Rvck9wdGlvbnMsIElKU0RPTSwgSU9wdGlvbnMsIElPcHRpb25zSlNET00sIGlzUGFja2VkSlNET00sIHBhY2tKU0RPTSwgcGFja09wdGlvbnMsIFVSTCwgVVJMSW1wbCB9IGZyb20gJy4vcGFjayc7XG5pbXBvcnQgeyBQcm9taXNlLCByZXF1ZXN0LCBSZXNwb25zZVJlcXVlc3QgfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCBwYXJzZUNvbnRlbnRUeXBlID0gcmVxdWlyZSgnY29udGVudC10eXBlLXBhcnNlcicpO1xuaW1wb3J0IGlzUGxhaW5PYmplY3QgPSByZXF1aXJlKCdpcy1wbGFpbi1vYmplY3QnKTtcbmltcG9ydCB7IElPcHRpb25zV2l0aFdpbmRvd09wdGlvbnNXaXRoUmVzb3VyY2VMb2FkZXIgfSBmcm9tICcuL2Jyb3dzZXIvcmVzb3VyY2UtbG9hZGVyJztcblxuaW1wb3J0IHsgTGF6eUNvb2tpZUphciwgTGF6eUNvb2tpZSwgUmVxdWVzdENvb2tpZUphciB9IGZyb20gJy4vY29va2llcyc7XG5leHBvcnQgeyBMYXp5Q29va2llSmFyLCBMYXp5Q29va2llIH1cblxuaW1wb3J0IHsgQ29va2llSmFyLCBSZXF1ZXN0SmFyLCB3cmFwQ29va2llSmFyRm9yUmVxdWVzdCwgSVJlcXVlc3RDb29raWVKYXIgfSBmcm9tICcuL2Nvb2tpZXMnO1xuZXhwb3J0IHsgQ29va2llSmFyLCBSZXF1ZXN0SmFyLCB3cmFwQ29va2llSmFyRm9yUmVxdWVzdCwgSVJlcXVlc3RDb29raWVKYXIgfVxuXG5leHBvcnQgeyBwYXJzZUNvbnRlbnRUeXBlIH1cbmV4cG9ydCB7IFVSTCwgVVJMSW1wbCB9XG5cbmV4cG9ydCB7IERFRkFVTFRfVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3QnO1xuaW1wb3J0IHsgREVGQVVMVF9VU0VSX0FHRU5ULCBTWU1CT0xfUkFXIH0gZnJvbSAnLi9jb25zdCc7XG5cbmltcG9ydCB7IG1pbmlmeUhUTUwsIG5vcm1hbGl6ZUhUTUwgfSBmcm9tICcuL2h0bWwnO1xuXG5leHBvcnQgeyB0b3VnaENvb2tpZSB9XG5cbmV4cG9ydCB0eXBlIElDb29raWVKYXIgPSBQYXJ0aWFsPENvb2tpZUphcj4gfCBQYXJ0aWFsPExhenlDb29raWVKYXI+O1xuXG5leHBvcnQgaW50ZXJmYWNlIElGcm9tVXJsT3B0aW9ucyBleHRlbmRzIElPcHRpb25zSlNET01cbntcblx0cmVxdWVzdE9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMsXG5cdGNvb2tpZUphcj86IElDb29raWVKYXIgfCBQYXJ0aWFsPExhenlDb29raWVKYXI+LFxuXG5cdGxpYlJlcXVlc3RQcm9taXNlPyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmVxdWVzdE9wdGlvbnNKU0RPTSBleHRlbmRzIFBhcnRpYWw8cmVxdWVzdC5SZXF1ZXN0UHJvbWlzZU9wdGlvbnM+XG57XG5cdHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlPzogYm9vbGVhbjtcblx0ZW5jb2Rpbmc/OiBudWxsO1xuXHRnemlwPzogYm9vbGVhbjtcblx0aGVhZGVycz86IENvcmVSZXF1ZXN0LkhlYWRlcnMgJiB7XG5cdFx0XCJVc2VyLUFnZW50XCI/OiBzdHJpbmc7XG5cdFx0UmVmZXJlcj86IHN0cmluZztcblx0XHRBY2NlcHQ/OiBzdHJpbmc7XG5cdFx0XCJBY2NlcHQtTGFuZ3VhZ2VcIj86IHN0cmluZztcblx0fTtcblx0amFyPzogSVJlcXVlc3RKYXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlcXVlc3RPcHRpb25zIGV4dGVuZHMgSVJlcXVlc3RPcHRpb25zSlNET01cbntcblx0bWV0aG9kPzogJ1BPU1QnIHwgJ0dFVCcgfCBzdHJpbmcsXG5cdGZvcm0/OiB7XG5cdFx0W2tleTogc3RyaW5nXTogYW55LFxuXHRcdFtrZXk6IG51bWJlcl06IGFueSxcblx0fSxcbn1cblxuZXhwb3J0IHR5cGUgSVJlcXVlc3RKYXIgPSBSZXF1ZXN0Q29va2llSmFyO1xuXG5leHBvcnQgZnVuY3Rpb24gZnJvbVVSTCh1cmw6IHN0cmluZyB8IFVSTCwgb3B0aW9ucz86IElGcm9tVXJsT3B0aW9ucyk6IFByb21pc2U8SUpTRE9NPlxue1xuXHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKVxuXHR7XG5cdFx0Y29uc3QgcGFyc2VkVVJMID0gbmV3IFVSTCh1cmwpO1xuXHRcdHVybCA9IHBhcnNlZFVSTC5ocmVmIGFzIHN0cmluZztcblxuXHRcdGxldCBvcHRzID0ge307XG5cblx0XHRvcHRpb25zID0gcGFja09wdGlvbnMob3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbnMpXG5cdFx0e1xuXHRcdFx0b3B0cyA9IG9wdGlvbnM7XG5cdFx0fSk7XG5cblx0XHRvcHRpb25zID0gbm9ybWFsaXplRnJvbVVSTE9wdGlvbnMob3B0aW9ucyk7XG5cdFx0bGV0IHJlcXVlc3RPcHRpb25zID0gbm9ybWFsaXplUmVxdWVzdE9wdGlvbnMob3B0aW9ucyk7XG5cblx0XHRsZXQgX3JlcXVlc3QgPSBvcHRpb25zLmxpYlJlcXVlc3RQcm9taXNlIHx8IHJlcXVlc3Q7XG5cblx0XHRyZXR1cm4gX3JlcXVlc3QodXJsLCByZXF1ZXN0T3B0aW9ucylcblx0XHRcdC50aGVuKChyZXM6IElSZXNwb25zZSkgPT5cblx0XHRcdHtcblx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRyZXR1cm4gcmVxdWVzdFRvSlNET00ocmVzLCBwYXJzZWRVUkwsIG9wdGlvbnMsIHJlcXVlc3RPcHRpb25zKTtcblx0XHRcdH0pXG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHQudGhlbihmdW5jdGlvbiAoanNkb206IElKU0RPTSlcblx0XHRcdHtcblx0XHRcdFx0aWYgKCFpc1BhY2tlZEpTRE9NKGpzZG9tKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHBhY2tKU0RPTShqc2RvbSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRqc2RvbS5fb3B0aW9ucy5Db25zdHJ1Y3Rvck9wdGlvbnMgPSBvcHRzO1xuXHRcdFx0XHRqc2RvbS5fb3B0aW9ucy5vcHRpb25zID0gb3B0aW9ucztcblx0XHRcdFx0anNkb20uX29wdGlvbnMucmVxdWVzdE9wdGlvbnMgPSByZXF1ZXN0T3B0aW9ucztcblxuXHRcdFx0XHRyZXR1cm4ganNkb20gYXMgSUpTRE9NO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3BvbnNlIGV4dGVuZHMgUmVzcG9uc2VSZXF1ZXN0XG57XG5cdGhlYWRlcnM6IHtcblx0XHRba2V5OiBzdHJpbmddOiBhbnksXG5cdH0sXG5cdHJlcXVlc3Q6IHtcblx0XHRocmVmPzogc3RyaW5nO1xuXHRcdFtrZXk6IHN0cmluZ106IGFueSxcblx0fVxuXHRib2R5OiBCdWZmZXIsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXF1ZXN0VG9KU0RPTTxUID0gSlNET00+KHJlczogSVJlc3BvbnNlLCBwYXJzZWRVUkw6IFVSTCB8IHN0cmluZywgb3B0aW9uczogUGFydGlhbDxJRnJvbVVybE9wdGlvbnM+LCByZXF1ZXN0T3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyk6IFRcbntcblx0aWYgKHR5cGVvZiBwYXJzZWRVUkwgPT0gJ3N0cmluZycpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0cGFyc2VkVVJMID0gbmV3IFVSTChwYXJzZWRVUkwpO1xuXHR9XG5cblx0bGV0IG9wdHMgPSB7fTtcblxuXHRvcHRpb25zID0gcGFja09wdGlvbnMob3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbnMpXG5cdHtcblx0XHRvcHRzID0gb3B0aW9ucztcblx0fSk7XG5cdG9wdGlvbnMgPSBub3JtYWxpemVGcm9tVVJMT3B0aW9ucyhvcHRpb25zKTtcblxuXHRjb25zdCBwYXJzZWRDb250ZW50VHlwZSA9IHBhcnNlQ29udGVudFR5cGUocmVzLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0pO1xuXHRjb25zdCB0cmFuc3BvcnRMYXllckVuY29kaW5nTGFiZWwgPSBwYXJzZWRDb250ZW50VHlwZSAmJiBwYXJzZWRDb250ZW50VHlwZS5nZXQoXCJjaGFyc2V0XCIpO1xuXG5cdG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKG9wdGlvbnMsIHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0dXJsOiByZXMucmVxdWVzdC5ocmVmICsgcGFyc2VkVVJMLmhhc2gsXG5cdFx0Y29udGVudFR5cGU6IHJlcy5oZWFkZXJzW1wiY29udGVudC10eXBlXCJdLFxuXHRcdHJlZmVycmVyOiByZXMucmVxdWVzdC5nZXRIZWFkZXIoXCJyZWZlcmVyXCIpLFxuXHRcdC8vW3RyYW5zcG9ydExheWVyRW5jb2RpbmdMYWJlbEhpZGRlbk9wdGlvbl06IHRyYW5zcG9ydExheWVyRW5jb2RpbmdMYWJlbFxuXHR9KTtcblxuXHRsZXQgYm9keSA9IG5vcm1hbGl6ZUhUTUwocmVzLmJvZHksIHRyYW5zcG9ydExheWVyRW5jb2RpbmdMYWJlbCkuaHRtbDtcblxuXHRpZiAob3B0aW9ucy5taW5pZnlIVE1MKVxuXHR7XG5cdFx0Ym9keSA9IG1pbmlmeUhUTUwoYm9keSk7XG5cdH1cblxuXHRsZXQganNkb20gPSBuZXcgSlNET00oYm9keSwgb3B0aW9ucyBhcyBJQ29uc3RydWN0b3JPcHRpb25zKTtcblxuXHRqc2RvbVtTWU1CT0xfUkFXXSA9IGpzZG9tW1NZTUJPTF9SQVddIHx8IHt9O1xuXHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zID0ganNkb21bU1lNQk9MX1JBV10ub3B0aW9ucyB8fCB7fTtcblx0anNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5vcHRpb25zID0ganNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5vcHRpb25zIHx8IG9wdGlvbnM7XG5cdGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMuQ29uc3RydWN0b3JPcHRpb25zID0ganNkb21bU1lNQk9MX1JBV10ub3B0aW9ucy5Db25zdHJ1Y3Rvck9wdGlvbnMgfHwgb3B0cztcblxuXHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLlJlc3BvbnNlID0gcmVzO1xuXHRqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLmJvZHkgPSBib2R5O1xuXG5cdGlmIChyZXF1ZXN0T3B0aW9ucylcblx0e1xuXHRcdGpzZG9tW1NZTUJPTF9SQVddLm9wdGlvbnMucmVxdWVzdE9wdGlvbnMgPSBqc2RvbVtTWU1CT0xfUkFXXS5vcHRpb25zLnJlcXVlc3RPcHRpb25zIHx8IHJlcXVlc3RPcHRpb25zO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4ganNkb207XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVSZXF1ZXN0T3B0aW9ucyhvcHRpb25zOiBJRnJvbVVybE9wdGlvbnMsIF9yZXF1ZXN0T3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyk6IFBhcnRpYWw8SVJlcXVlc3RPcHRpb25zPlxue1xuXHQvLyBAdHMtaWdub3JlXG5cdGxldCByZXF1ZXN0T3B0aW9uczogUGFydGlhbDxJUmVxdWVzdE9wdGlvbnM+ID0ge1xuXHRcdHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuXHRcdGVuY29kaW5nOiBudWxsLCAvLyBpLmUuLCBnaXZlIG1lIHRoZSByYXcgQnVmZmVyXG5cdFx0Z3ppcDogdHJ1ZSxcblx0XHRoZWFkZXJzOiB7XG5cdFx0XHRcIlVzZXItQWdlbnRcIjogb3B0aW9ucy51c2VyQWdlbnQgfHwgREVGQVVMVF9VU0VSX0FHRU5ULFxuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0UmVmZXJlcjogb3B0aW9ucy5yZWZlcnJlcixcblx0XHRcdEFjY2VwdDogXCJ0ZXh0L2h0bWwsYXBwbGljYXRpb24veGh0bWwreG1sLGFwcGxpY2F0aW9uL3htbDtxPTAuOSwqLyo7cT0wLjhcIixcblx0XHRcdFwiQWNjZXB0LUxhbmd1YWdlXCI6IFwiZW5cIlxuXHRcdH0sXG5cdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdGphcjogd3JhcENvb2tpZUphckZvclJlcXVlc3Qob3B0aW9ucy5jb29raWVKYXIpXG5cdH07XG5cblx0aWYgKG9wdGlvbnMucmVxdWVzdE9wdGlvbnMgfHwgX3JlcXVlc3RPcHRpb25zKVxuXHR7XG5cdFx0cmVxdWVzdE9wdGlvbnMgPSBkZWVwbWVyZ2UuYWxsKFtcblx0XHRcdHJlcXVlc3RPcHRpb25zLFxuXHRcdFx0b3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyB8fCB7fSxcblx0XHRcdF9yZXF1ZXN0T3B0aW9ucyB8fCB7fSxcblx0XHRcdHtcblx0XHRcdFx0ZW5jb2Rpbmc6IG51bGwsXG5cdFx0XHR9LFxuXHRcdF0sIHtcblx0XHRcdC8va2V5VmFsdWVPck1vZGU6IHRydWUsXG5cdFx0XHRpc01lcmdlYWJsZU9iamVjdCh2YWx1ZSwgaXNNZXJnZWFibGUpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBib29sID0gaXNNZXJnZWFibGUodmFsdWUpO1xuXG5cdFx0XHRcdGlmIChib29sICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRib29sID0gaXNQbGFpbk9iamVjdCh2YWx1ZSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gYm9vbDtcblx0XHRcdH0sXG5cdFx0fSk7XG5cdH1cblxuXHRyZXR1cm4gcmVxdWVzdE9wdGlvbnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVGcm9tVVJMT3B0aW9uczxUPihvcHRpb25zOiBQYXJ0aWFsPFQgJiBJRnJvbVVybE9wdGlvbnM+KTogUGFydGlhbDxUICYgSUZyb21VcmxPcHRpb25zPlxue1xuXHQvLyBOb3JtYWxpemF0aW9uIG9mIG9wdGlvbnMgd2hpY2ggbXVzdCBiZSBkb25lIGJlZm9yZSB0aGUgcmVzdCBvZiB0aGUgZnJvbVVSTCBjb2RlIGNhbiB1c2UgdGhlbSwgYmVjYXVzZSB0aGV5IGFyZVxuXHQvLyBnaXZlbiB0byByZXF1ZXN0KClcblx0Y29uc3Qgbm9ybWFsaXplZDogUGFydGlhbDxUICYgSUZyb21VcmxPcHRpb25zPiA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xuXHRpZiAob3B0aW9ucy51c2VyQWdlbnQgPT09IHVuZGVmaW5lZClcblx0e1xuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRub3JtYWxpemVkLnVzZXJBZ2VudCA9IERFRkFVTFRfVVNFUl9BR0VOVDtcblx0fVxuXG5cdGlmIChvcHRpb25zLnJlZmVycmVyICE9PSB1bmRlZmluZWQpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0bm9ybWFsaXplZC5yZWZlcnJlciA9IChuZXcgVVJMKG9wdGlvbnMucmVmZXJyZXIpKS5ocmVmO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMuY29va2llSmFyID09PSB1bmRlZmluZWQpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0bm9ybWFsaXplZC5jb29raWVKYXIgPSBuZXcgTGF6eUNvb2tpZUphcigpO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRkZWxldGUgbm9ybWFsaXplZC51cmw7XG5cdC8vIEB0cy1pZ25vcmVcblx0ZGVsZXRlIG5vcm1hbGl6ZWQuY29udGVudFR5cGU7XG5cblx0cmV0dXJuIG5vcm1hbGl6ZWQ7XG5cblx0Ly8gQWxsIG90aGVyIG9wdGlvbnMgZG9uJ3QgbmVlZCB0byBiZSBwcm9jZXNzZWQgeWV0LCBhbmQgY2FuIGJlIHRha2VuIGNhcmUgb2YgaW4gdGhlIG5vcm1hbCBjb3Vyc2Ugb2YgdGhpbmdzIHdoZW5cblx0Ly8gYGZyb21VUkxgIGNhbGxzIGBuZXcgSlNET00oaHRtbCwgb3B0aW9ucylgLlxufVxuXG5leHBvcnQgZGVmYXVsdCBleHBvcnRzIGFzIHR5cGVvZiBpbXBvcnQoJy4vZnJvbS11cmwnKTtcbiJdfQ==